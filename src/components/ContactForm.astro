---
import { Image } from "astro:assets";
import picture from "../images/form-image.png";
---

<section
  id="contact"
  class="max-w-(--max-width) mx-auto px-6 pb-12 flex flex-col md:flex-row gap-10">
  <!-- left side -->

  <div class="md:w-1/2" id="contact">
    <h3 class="text-xl font-bold mb-4">Book a Call</h3>
    <form
      id="contact-form"
      method="POST"
      action="/api/contact"
      class="grid gap-4 md:max-w-xl"
      autocomplete="off">
      <!-- name -->
      <div>
        <input
          type="text"
          id="name-input"
          name="name"
          placeholder="Your Name"
          required
          class="border rounded-lg p-3 w-full"
          aria-describedby="name-error"
        />
        <p
          id="name-error"
          class="text-red-600 text-sm mt-1 hidden"
          role="alert">
        </p>
      </div>
      <!-- phone number -->
      <div>
        <input
          type="text"
          id="phone-input"
          name="phone_number"
          placeholder="Phone Number"
          class="border rounded-lg p-3 w-full"
          required
          aria-describedby="phone-error"
        />
        <p
          id="phone-error"
          class="text-red-600 text-sm mt-1 hidden"
          role="alert">
        </p>
      </div>
      <!-- email -->
      <input
        type="text"
        name="email"
        placeholder="Email"
        class="border rounded-lg p-3"
      />
      <!-- ignore the textarea tag to prevent whitespace appearing inside textarea -->
      <!-- prettier-ignore -->
      <textarea
      name="message"
      placeholder="How can we help you?"
      rows="6"
      class="border rounded-lg p-3 resize-none"></textarea>
      <!-- Honeypot field -->
      <div style="display:none;">
        <input type="text" name="honeypot" tabindex="-1" autocomplete="off" />
      </div>
      <!-- submit button -->
      <button
        type="submit"
        class="bg-gray-900 text-white px-4 py-2 rounded-lg cursor-pointer">
        Boost My Sales
      </button>
    </form>
  </div>
  <!-- right side -->
  <div class="flex justify-center items-center p-6 flex-1">
    <Image src={picture} alt="productivity" class="" />
  </div>
</section>

<script>
  // Get form and input elements
  const form = document.getElementById(
    "contact-form"
  ) as HTMLFormElement | null;
  const nameInput = document.getElementById(
    "name-input"
  ) as HTMLInputElement | null;
  const phoneInput = document.getElementById(
    "phone-input"
  ) as HTMLInputElement | null;
  const nameError = document.getElementById(
    "name-error"
  ) as HTMLParagraphElement | null;
  const phoneError = document.getElementById(
    "phone-error"
  ) as HTMLParagraphElement | null;

  // Early return if elements are not found
  if (!form || !nameInput || !phoneInput || !nameError || !phoneError) {
    console.error("Contact form elements not found");
    throw new Error("Contact form elements not found");
  }

  // At this point, TypeScript knows all elements are non-null
  // Validation functions
  function validateName(): boolean {
    const name = nameInput!.value.trim();
    if (!name) {
      nameError!.textContent = "Name is required";
      nameError!.classList.remove("hidden");
      nameInput!.classList.add("border-red-500");
      return false;
    }
    nameError!.classList.add("hidden");
    nameInput!.classList.remove("border-red-500");
    return true;
  }

  function validatePhone(): boolean {
    const phone = phoneInput!.value.trim();
    if (!phone) {
      phoneError!.textContent = "Phone number is required";
      phoneError!.classList.remove("hidden");
      phoneInput!.classList.add("border-red-500");
      return false;
    }

    // Remove all non-digit characters (for length check)
    const digitsOnly = phone.replace(/\D/g, "");
    // Check: at least 10 digits (adjust based on your region)
    if (digitsOnly.length < 10) {
      phoneError!.textContent =
        "Please enter a valid phone number (e.g. (123) 456-7890)";
      phoneError!.classList.remove("hidden");
      phoneInput!.classList.add("border-red-500");
      return false;
    }
    // Optional: validate format with a loose pattern
    // Allows: +1 (123) 456-7890, 123-456-7890, (123) 456 7890, etc.
    const phonePattern = /^[\+]?[0-9\s\-\(\)]{10,}$/;
    if (!phonePattern.test(phone)) {
      phoneError!.textContent =
        "Please use a valid phone format (e.g. (123) 456-7890)";
      phoneError!.classList.remove("hidden");
      phoneInput!.classList.add("border-red-500");
      return false;
    }

    // Success
    phoneError!.classList.add("hidden");
    phoneInput!.classList.remove("border-red-500");
    return true;
  }

  // Real-time validation on blur
  nameInput.addEventListener("blur", validateName);
  phoneInput.addEventListener("blur", validatePhone);

  // Clear errors on input
  nameInput.addEventListener("input", () => {
    if (nameError!.textContent) {
      nameError!.classList.add("hidden");
      nameInput!.classList.remove("border-red-500");
    }
  });

  phoneInput.addEventListener("input", () => {
    if (phoneError!.textContent) {
      phoneError!.classList.add("hidden");
      phoneInput!.classList.remove("border-red-500");
    }
  });

  function showError(message: string) {
    let alert = document.getElementById("form-alert");
    // Add element to DOM
    if (!alert) {
      alert = document.createElement("p");
      alert.id = "form-alert";
      alert.className = "text-red-600 mt-3";
      form?.appendChild(alert);
    }
    alert.textContent = message;
  }

  function showSuccess(message: string) {
    let alert = document.getElementById("form-alert");
    // Add element to DOM
    if (!alert) {
      alert = document.createElement("p");
      alert.id = "form-alert";
      alert.className = "text-green-700 mt-3";
      form?.appendChild(alert);
    }
    alert.textContent = message;
  }

  // Form submission validation
  form.addEventListener("submit", async (e) => {
    e.preventDefault(); // Stop normal submission

    const isNameValid = validateName();
    const isPhoneValid = validatePhone();

    if (!isNameValid || !isPhoneValid) return;

    const formData = new FormData(form);

    try {
      const res = await fetch("/api/contact", {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        const data = await res.json().catch(() => null);

        const msg = data?.error || "Something went wrong. Please try again.";
        showError(msg);
        return;
      }

      // If the server redirects (302), we must manually follow it
      if (res.redirected) {
        window.location.href = res.url;
        return;
      }

      showSuccess("Message sent! Redirecting...");
      setTimeout(() => (window.location.href = "/booking"), 500);
    } catch (err) {
      showError("Network error. Please try again.");
    }
  });
</script>
